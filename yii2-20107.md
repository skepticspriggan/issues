# [Mark client-side scripts as safe to use for browsers (#20087)](https://github.com/yiisoft/yii2/pull/20107)

- _Type:_ Pull Request
- _State:_ closed
- _Repository:_ `yii2`
- _Created at:_ 2024-01-27 13:59:03

| Q             | A
| ------------- | ---
| Is bugfix?    | n
| New feature?  | y
| Breaks BC?    | n
| Fixed issues  | #20087 

The important choices made and the reasons why are summarized below. I'm open to suggestions for improvements.

**What attribute should be added to the script tag?**

_Only the nonce_

- Nonce use-case is easy to find in the API docs
- Less flexible

_Custom attributes_

- Nonce use-case is easy to find if explained in the general docs
- More flexible

### Solution 1 -- Only the nonce

This section assumes only the nonce is added.

**Where should the nonce script attribute be added?**

_In the BaseHtml helper_

Set the nonce attribute in all script tags via `yii\helpers\BaseHtml::script()` when it exists. This is similar to how the hidden CSRF token input is added to all forms via `yii\helpers\BaseHtml::beginForm()`. 

Adding it at a low level ensures all script tags are whitelisted and makes it easier to maintain.

**How should the nonce be called?**

_From a function in the Response component_

```php
$nonce = Yii::$app->response->getCspNonce();
```

**Where should the nonce be set?**

_In the application configuration_

```php
'components' => [
    'response' => [
        'class' => 'yii\web\Response',
        'cspNonce' => $nonce,
    ],
],
```

### Solution 2 -- Custom attributes

Set custom script attributes centrally in web.php:

```php
'components' => [
    'view' => [
        'class' => 'yii\web\View',
        'scriptOptions' => ['nonce' => $nonce],
    ],
],
```

Updates required to make this work:

- Add the variable `jsOptions` to `yii\web\View`.
- Load the default options from `jsOptions` inside `yii\helpers\Html::script()`.

## Comments

what-the-diff[bot] on 2024-01-27 13:59

> ## PR Summary

* **Improved Security Feature in Changelog**
  The update includes a notable enhancement to make client-side scripts safer for browsers. This is a notable change as it bolsters the overall security of the application.

* **Added Support for Content Security Policy (CSP) Nonce**
  This update now allows the integration of a nonce (a randomly generated string) in the `<script>` tags within our HTML code. This drastically improves our content security policy, making our web content more resilient to malicious attacks.

* **Enhanced Response Handling**
  The PR has updated how responses are handled by including a property for the CSP nonce. This includes getter and setter methods for the nonce and a method to load the nonce from the header.

* **Additional Unit Tests**
 Finally, the PR includes additional unit tests to make sure the new changes about CSP nonce are working as intended. These tests work by checking every small unit of our code, especially the ones that have just been updated, ensuring the entire system is working correctly.

codecov[bot] on 2024-01-27 14:01

> ## [Codecov](https://app.codecov.io/gh/yiisoft/yii2/pull/20107?dropdown=coverage&src=pr&el=h1&utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=yiisoft) Report
All modified and coverable lines are covered by tests :white_check_mark:
> Project coverage is 63.42%. Comparing base [(`f7cba1b`)](https://app.codecov.io/gh/yiisoft/yii2/commit/f7cba1b9de5efec695771868931ac48c0bd85a2f?dropdown=coverage&el=desc&utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=yiisoft) to head [(`3071e20`)](https://app.codecov.io/gh/yiisoft/yii2/pull/20107?dropdown=coverage&src=pr&el=desc&utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=yiisoft).


<details><summary>Additional details and impacted files</summary>


```diff
@@             Coverage Diff              @@
##             master   #20107      +/-   ##
============================================
- Coverage     63.64%   63.42%   -0.22%     
- Complexity    11376    11378       +2     
============================================
  Files           429      429              
  Lines         37073    37077       +4     
============================================
- Hits          23594    23515      -79     
- Misses        13479    13562      +83     
```



</details>

[:umbrella: View full report in Codecov by Sentry](https://app.codecov.io/gh/yiisoft/yii2/pull/20107?dropdown=coverage&src=pr&el=continue&utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=yiisoft).   
:loudspeaker: Have feedback on the report? [Share it here](https://about.codecov.io/codecov-pr-comment-feedback/?utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=yiisoft).

rob006 on 2024-01-30 17:02

> > Easier to use when nonce is generated at webserver level: No configuration required as the nonce is automatically read from the header.

Are you sure about that? AFAIK if header is added by webserver, it is done after generating response by PHP, so PHP does not have access to this header.

skepticspriggan on 2024-02-02 09:03

> > AFAIK if header is added by webserver, it is done after generating response by PHP, so PHP does not have access to this header.

You are right, that was an incorrect assumption. I will revise the request. This will make the comparison easier.

skepticspriggan on 2024-02-19 13:58

> The initial solution of setting only the CSP nonce via the Response property in the application configuration has become less attractive after review. What do you think about the new version?

samdark on 2024-03-24 21:14

> It looks OK.

skepticspriggan on 2024-03-25 15:05

> It seems the `scriptOptions` variable got lost somewhere causing an error:

```
yii\base\UnknownPropertyException: Setting unknown property: yii\web\View::scriptOptions
```

I will add the missing variable shortly.

samdark on 2024-04-03 13:18

> Thanks!

skepticspriggan on 2024-04-04 18:52

> Glad to contribute :)
