# [Mark client-side scripts as safe to use for browsers (#20087)](https://github.com/yiisoft/yii2/pull/20107)

- _Type:_ Pull Request
- _State:_ closed
- _Repository:_ `yii2`
- _Created at:_ 2024-01-27 13:59:03

| Q             | A
| ------------- | ---
| Is bugfix?    | n
| New feature?  | y
| Breaks BC?    | n
| Fixed issues  | #20087 

The important choices made and the reasons why are summarized below. I'm open to suggestions for improvements.

**What attribute should be added to the script tag?**

_Only the nonce_

- Nonce use-case is easy to find in the API docs
- Less flexible

_Custom attributes_

- Nonce use-case is easy to find if explained in the general docs
- More flexible

### Solution 1 -- Only the nonce

This section assumes only the nonce is added.

**Where should the nonce script attribute be added?**

_In the BaseHtml helper_

Set the nonce attribute in all script tags via `yii\helpers\BaseHtml::script()` when it exists. This is similar to how the hidden CSRF token input is added to all forms via `yii\helpers\BaseHtml::beginForm()`. 

Adding it at a low level ensures all script tags are whitelisted and makes it easier to maintain.

**How should the nonce be called?**

_From a function in the Response component_

```php
$nonce = Yii::$app->response->getCspNonce();
```

**Where should the nonce be set?**

_In the application configuration_

```php
'components' => [
    'response' => [
        'class' => 'yii\web\Response',
        'cspNonce' => $nonce,
    ],
],
```

### Solution 2 -- Custom attributes

Set custom script attributes centrally in web.php:

```php
'components' => [
    'view' => [
        'class' => 'yii\web\View',
        'scriptOptions' => ['nonce' => $nonce],
    ],
],
```

Updates required to make this work:

- Add the variable `jsOptions` to `yii\web\View`.
- Load the default options from `jsOptions` inside `yii\helpers\Html::script()`.

## Comments

rob006 on 2024-01-30 17:02

> > Easier to use when nonce is generated at webserver level: No configuration required as the nonce is automatically read from the header.
> 
> Are you sure about that? AFAIK if header is added by webserver, it is done after generating response by PHP, so PHP does not have access to this header.

skepticspriggan on 2024-02-02 09:03

> > AFAIK if header is added by webserver, it is done after generating response by PHP, so PHP does not have access to this header.
> 
> You are right, that was an incorrect assumption. I will revise the request. This will make the comparison easier.

skepticspriggan on 2024-02-19 13:58

> The initial solution of setting only the CSP nonce via the Response property in the application configuration has become less attractive after review. What do you think about the new version?

samdark on 2024-03-24 21:14

> It looks OK.

skepticspriggan on 2024-03-25 15:05

> It seems the `scriptOptions` variable got lost somewhere causing an error:
> 
> ```
> yii\base\UnknownPropertyException: Setting unknown property: yii\web\View::scriptOptions
> ```
> 
> I will add the missing variable shortly.

samdark on 2024-04-03 13:18

> Thanks!

skepticspriggan on 2024-04-04 18:52

> Glad to contribute :)

## Reviews

samdark on 2024-04-03 13:17

framework/web/View.php

```
@@ -131,6 +131,10 @@ class View extends \yii\base\View
      * @see registerJsFile()
      */
     public $jsFiles = [];
+    /**
+     * @var array the script tag options.
```

> ```suggestion
>      * @since 2.0.50
>      * @var array the script tag options.
> ```
